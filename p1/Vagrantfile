# P1 - K3s and Vagrant
# 2 VMs (server + worker) on Ubuntu 22.04 with libvirt
# Server IP: 192.168.56.110, Worker IP: 192.168.56.111

cluster_token = "IOT42ClusterToken"

Vagrant.configure("2") do |config|
  # Libvirt-capable Ubuntu 22.04 box
  config.vm.box = "generic/ubuntu2204"
  config.ssh.insert_key = false

  # -------- K3s SERVER (controller) --------
  config.vm.define "alrahmouS" do |srv|
    srv.vm.hostname = "alrahmouS"
    srv.vm.network "private_network", ip: "192.168.56.110"

    srv.vm.provider :libvirt do |v|
      v.cpus   = 1
      v.memory = 512
      # optional nic model tweak if needed:
      # v.nic_model_type = "virtio"
    end

    # K3s server provision script
    srv.vm.provision "shell",
      path: "scripts/k3s_server.sh",
      env: {
        "SERVER_IP"     => "192.168.56.110",
        "CLUSTER_TOKEN" => cluster_token
      }
  end

  # -------- K3s WORKER (agent) --------
  config.vm.define "alrahmouSW" do |wrk|
    wrk.vm.hostname = "alrahmouSW"
    wrk.vm.network "private_network", ip: "192.168.56.111"

    wrk.vm.provider :libvirt do |v|
      v.cpus   = 1
      v.memory = 512
      # v.nic_model_type = "virtio"
    end

    # K3s worker provision script
    wrk.vm.provision "shell",
      path: "scripts/k3s_worker.sh",
      env: {
        "SERVER_IP"     => "192.168.56.110",
        "WORKER_IP"     => "192.168.56.111",
        "CLUSTER_TOKEN" => cluster_token
      }
  end
end
