# p1/Vagrantfile
# Inception-of-Things (IoT) - Part 1
# 2 machines via Vagrant: alrahmouS (server) and alrahmouSW (worker)
# Required IPs: 192.168.56.110 / 192.168.56.111 [file:1]

CLUSTER_TOKEN = "IOT42ClusterToken"

Vagrant.configure("2") do |config|
  # "latest stable" distro: pick what you want; 24.04 is a safe choice. [file:1]
  config.vm.box = "bento/ubuntu-24.04"

  # Keep default vagrant key behavior (passwordless `vagrant ssh`). [file:1]
  config.ssh.insert_key = false

  # ---- SERVER (controller) ----
  config.vm.define "alrahmouS" do |srv|
    srv.vm.hostname = "alrahmouS" # login + "S" [file:1]

    srv.vm.network "private_network",
      ip: "192.168.56.110",
      libvirt__network_name: "iot56",
      libvirt__netmask: "255.255.255.0"

    srv.vm.provider :libvirt do |v|
      v.cpus   = 1
      v.memory = 1024 # 512 can work, 1024 is safer for k3s [file:1]
    end

    srv.vm.provision "shell",
      path: "scripts/k3s_server.sh",
      env: {
        "SERVER_IP"     => "192.168.56.110",
        "CLUSTER_TOKEN" => CLUSTER_TOKEN
      }
  end

  # ---- WORKER (agent) ----
  config.vm.define "alrahmouSW" do |wrk|
    wrk.vm.hostname = "alrahmouSW" # login + "SW" [file:1]

    wrk.vm.network "private_network",
      ip: "192.168.56.111",
      libvirt__network_name: "iot56",
      libvirt__netmask: "255.255.255.0"

    wrk.vm.provider :libvirt do |v|
      v.cpus   = 1
      v.memory = 1024
    end

    wrk.vm.provision "shell",
      path: "scripts/k3s_worker.sh",
      env: {
        "SERVER_IP"     => "192.168.56.110",
        "WORKER_IP"     => "192.168.56.111",
        "CLUSTER_TOKEN" => CLUSTER_TOKEN
      }
  end
end
